<%
function timeAgo(date) {
  const seconds = Math.floor((Date.now() - new Date(date)) / 1000);
  const intervals = [
    { label: 'year', seconds: 31536000 },
    { label: 'month', seconds: 2592000 },
    { label: 'day', seconds: 86400 },
    { label: 'hour', seconds: 3600 },
    { label: 'minute', seconds: 60 },
  ];

  for (const i of intervals) {
    const count = Math.floor(seconds / i.seconds);
    if (count >= 1) {
      return `${count} ${i.label}${count > 1 ? 's' : ''} ago`;
    }
  }
  return 'just now';
}
%>

<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head') %>
  <title><%= blog.title %></title>

  <!-- Page-specific CSS -->
  <link rel="stylesheet" href="/css/pages/blog.css">
</head>

<body>
  <%- include('./partials/nav') %>

  <div class="container blog-container py-4">

    <!-- Blog Title -->
    <h1 class="blog-title mb-2"><%= blog.title %></h1>

    <!-- Author + Meta Row -->
    <div class="blog-meta-row">

      <!-- Author -->
      <div class="author-inline">
        <img src="<%= blog.createdBy.profileImageURL %>" alt="Author">
        <span><%= blog.createdBy.fullName %></span>
      </div>

      <!-- Date Info -->
      <div class="blog-meta">
        Posted <%= timeAgo(blog.createdAt) %>
        <% if (blog.updatedAt && blog.updatedAt.getTime() !== blog.createdAt.getTime()) { %>
          • Edited <%= timeAgo(blog.updatedAt) %>
        <% } %>
      </div>

    </div>

    <!-- Cover Image -->
    <img 
      src="/<%= blog.coverImageURL %>" 
      class="blog-cover" 
      alt="Blog cover"
    >
    <!-- Edit + Delete (Owner only) -->
    <% if (locals.user && String(user._id) === String(blog.createdBy._id)) { %>
      <div style="display:flex; gap:10px; margin-bottom:1.5rem;">
        <a href="/blog/edit/<%= blog._id %>" class="btn btn-sm btn-warning">
          Edit Blog
        </a>

        <form action="/blog/delete/<%= blog._id %>" method="POST">
          <button 
            type="submit" 
            class="btn btn-sm btn-danger"
            onclick="return confirm('Are you sure you want to delete this blog?');"
          >
            Delete Blog
          </button>
        </form>
      </div>
    <% } %>


    <!-- Blog Body -->
    <div class="blog-body">
      <%- blog.body %>
    </div>

    <!-- Comments -->
    <div class="comments-wrapper">

      <% if (locals.user) { %>
        <div class="comment-form">
          <h6 class="mb-2">
            Comments (<%= comments.length %>)
          </h6>

          <form action="/blog/comment/<%= blog._id %>" method="POST">
            <input
              type="text"
              class="form-control mb-2"
              name="content"
              placeholder="Write a comment…"
              required
            >
            <button type="submit" class="btn btn-primary btn-sm">
              Post
            </button>
          </form>
        </div>
      <% } %>

      <% comments.forEach(comment => { %>
        <div class="comment-item">
          <img src="<%= comment.createdBy.profileImageURL %>" class="comment-avatar">

          <div class="comment-body">
            <div class="comment-author">
              <%= comment.createdBy.fullName %>
            </div>
            <div class="comment-date">
              <%= timeAgo(comment.createdAt) %>
            </div>
            <div class="comment-text">
              <%= comment.content %>
            </div>
          </div>
        </div>
      <% }); %>

    </div>
  </div>

  <%- include('./partials/scripts') %>
</body>
</html>
